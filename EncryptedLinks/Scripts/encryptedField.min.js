(function(n){"use strict";n.string={htmlEncode:function(n){return undefined!==STSHtmlEncode?STSHtmlEncode(n):$("<div/>").text(n).html()},htmlDecode:function(n){return undefined!==STSHtmlDecode?STSHtmlDecode(n):$("<div/>").html(n).text()},format:function(){for(var r,u,t=arguments,i=t[0],n=0;n<t.length-1;n++)r=("{"+n+"}").replace(/([*+.?|\\\[\]{}()])/g,"\\$1"),u=new RegExp(r,"g"),i=i.replace(u,t[n+1]);return i},startsWith:function(n,t){return t.length>0&&n.substring(0,t.length)===t},endsWith:function(n,t){return t.length>0&&n.substring(n.length-t.length,n.length)===t}}})(window.xSolon=window.xSolon||{}),function(n){function r(){var t=this,o="textarea",f,e;t.registerLocalKey=function(n,i){i?t.privateKey=u[n]:t.publicKey=u[n]};var u=[],r={tmpLocalKeyMenu:'<ie:menuitem type="option" IconSrc="/_layouts/images/{0}" onMenuClick="xSolon.RSA.registerLocalKey({1},{2})" text="{3}" description="{4}"><\/ie:menuitem>',tmpMenu:'<ie:menuitem type="option" IconSrc="{0}" onMenuClick="{1}" text="{2}" description="{3}"><\/ie:menuitem>',tmpMainMenu:'<span style="display: none;min-height:100px;"><menu id="{0}" largeiconmode="true">{1}<\/menu><\/span><div  style="display:inline;float:right">    <span>        <div nowrap="nowrap" onmouseover="MMU_PopMenuIfShowing(this);MMU_EcbTableMouseOverOut(this, true)" onclick="MMU_Open(byid(\'{0}\'),MMU_GetMenuFromClientId(\'{2}\'),event,false, null, 0);" oncontextmenu="this.click(); return false;" foa="MMU_GetMenuFromClientId(\'{2}\')" hoverinactive="" hoveractive="ms-siteactionsmenuhover">            <a class="ms-unselectedtitle" id="{2}" style="white-space: nowrap;" onkeydown="MMU_EcbLinkOnKeyDown(byid(\'{0}\'), MMU_GetMenuFromClientId(\'{2}\'), event);" onclick="MMU_Open(byid(\'{0}\'), MMU_GetMenuFromClientId(\'{2}\'),event,false, null, 0);" onfocus="MMU_EcbLinkOnFocusBlur(byid(\'{0}\'), this, true);" oncontextmenu="this.click(); return false;" href="#" serverclientid="{2}">More...<img align="bottom" src="/_layouts/images/TriDownBlue.GIF" border="0"><\/a>        <\/div>    <\/span><\/div>',getMenuMarkup:function(t){for(var i,e=[{img:"/_layouts/images/LTOBJECT.GIF",text:"Create new keys",action:"xSolon.RSA.Options.New();",desc:"Create Public/Private encryption keys"},{img:"/_layouts/images/menudownload.GIF",text:"Register cloud keys",action:"xSolon.RSA.Options.Cloud();",desc:"Use keys stored in your private cloud."}],u="",f=0;f<e.length;f++)i=e[f],u+=n.string.format(r.tmpMenu,i.img,i.action,i.text,i.desc);return u+='<ie:menuitem class="xSolkeyMenu" text="Register local keys" type="submenu" description="Use keys from the local keys list." IconSrc="/_layouts/images/securityconfig.gif">\t\t\t\t\t\t\t\t<ie:menuitem type="label">\t\t\t\t\t\t\t\t<\/ie:menuitem>\t\t\t\t\t\t\t<\/ie:menuitem>',n.string.format(r.tmpMainMenu,t,u,t+"Menu")},render:function(n,t){var i;return n==null||n.CurrentFieldValue==null?"":(i=SPClientTemplates.Utility.GetFormContextForCurrentField(n),i==null||i.fieldSchema==null)?"":(h(i),r.renderForm(i,c(n)||"",t))},renderForm:function(t,i,u){var o=r.getMenuMarkup(t.fieldName),s=n.string.format("<div id='section{0}'><{2} id='txt{0}' type='text' name='txt{0}' class='ms-long' rows='6'><\/{2}><\/div><a href='#' onclick='xSolon.RSA.Encrypt(\"txt{0}\");'>Encrypt<\/a> | <a href='#' onclick='xSolon.RSA.Decrypt(\"txt{0}\");'>Decrypt<\/a> {3}",t.fieldName,i,u,o),e=$("<div><div>"+s+"<\/div><\/div>"),f=e.find("#txt"+t.fieldName);return u.search(/input/i)===0?f.attr("value",i):u.search(/div/i)===0?f.html(i):f.val(i),e.html()}},l=function(n){return n.CurrentFieldSchema.Name},h=function(t){t.registerInitCallback(t.fieldName,function(){var f;console.log("registerInitCallback"+t.fieldName);var i=SP.ClientContext.get_current(),o=i.get_web(),s=o.get_lists().getByTitle("Keys"),h=n.string.htmlDecode(n.string.format(n.string.htmlEncode('<View><Query><Where>{0}<\/Where><OrderBy><FieldRef Name="Title" /><\/OrderBy><\/Query><RowLimit>100<\/RowLimit><\/View>'),"")),e=new SP.CamlQuery;e.set_viewXml(h);f=s.getItems(e);i.load(f);i.executeQueryAsync(function(){var e=f.getEnumerator(),i="";for(u=[];e.moveNext();){var t=e.get_current(),o=t.get_item("Title"),s=t.get_item("_Comments"),h=t.get_item("PrivateKey"),c=t.get_item("PublicKey");h&&(i+=n.string.format(r.tmpLocalKeyMenu,"P1216.GIF",u.length,"true",o+" - Private",s),u.push(h));c&&(i+=n.string.format(r.tmpLocalKeyMenu,"P7R16.GIF",u.length,"false",o+" - Public",s),u.push(c))}$(".xSolkeyMenu").html(i)},function(t,i){console.log(n.string.format("{0} {1}",i.get_message(),i.get_stackTrace()))})});t.registerGetValueCallback(t.fieldName,function(){console.log("GetValueCallback"+t.fieldName);return $("#txt"+t.fieldName).val()});var i=new SPClientForms.ClientValidation.ValidatorSet;t.fieldSchema.Required&&i.RegisterValidator(new SPClientForms.ClientValidation.RequiredValidator);i._registeredValidators.length>0&&t.registerClientValidator(t.fieldName,i);t.registerValidationErrorCallback(t.fieldName,function(n){SPFormControl_AppendValidationErrorMessage("section"+t.fieldName,n)})},c=function(n){var t=null;return n!=null&&n.CurrentItem!=null&&(t=n.CurrentItem[n.CurrentFieldSchema.Name]),t},s=function(n){var r=new $.Deferred,f,i,u;return n&&undefined===t.privateKey?(SP.UI.Notify.addNotification("Error: Private Key is required for decryption.",!1),r.reject()):(f=function(){var n=SP.UI.$create_DialogOptions(),t;return n.title="Enter Password",n.autoSize=!0,n.allowMaximize=!0,t='<div id="passwordDialog4">                    <div class="control-group">                        <label class="control-label" for="passwordinput">Password Input<\/label>                        <div class="controls">                            <input id="passwordinput1" name="passwordinput1" type="password" placeholder="password here" class="input-xlarge" />                        <\/div>                    <\/div><br />                    <button onclick="SP.UI.ModalDialog.commonModalDialogClose(1,$(\'#passwordinput1\').val());return false;" class="btn btn-primary">Submit<\/button>                <\/div>',n.html=$(t)[0],n.args={},n},i=new JSEncrypt,undefined!==t.privateKey?"object"==typeof t.privateKey||t.privateKey.search(/:/)>0?(u=f(),u.dialogReturnValueCallback=function(n,u){n==1?(i.setPrivateKey(sjcl.decrypt(u,"object"==typeof t.privateKey?JSON.stringify(t.privateKey):t.privateKey)),r.resolve(i)):r.reject()},SP.UI.ModalDialog.showModalDialog(u)):(i.setPrivateKey(t.privateKey),r.resolve(i)):undefined!==t.publicKey?"object"==typeof t.publicKey||t.publicKey.search(/:/)>0?(u=f(),u.dialogReturnValueCallback=function(n,u){n==1?(i.setPublicKey(sjcl.decrypt(u,"object"==typeof t.publicKey?JSON.stringify(t.publicKey):t.publicKey)),r.resolve(i)):r.reject()},SP.UI.ModalDialog.showModalDialog(u)):(i.setPublicKey(t.publicKey),r.resolve(i)):(alert("RSA keys are not registered. Click on the registration shortcut."),i=null,r.reject())),r.promise()};t.View=function(){return"Encrypted field"};t.Display=function(n){return r.render(n,"div")};t.Edit=function(n,t){return r.render(n,t||o)};t.New=function(n,t){return r.render(n,t||o)};f=function(n){return n[0].nodeName.search(/div/i)===0?n.text():n.val()};e=function(n,t){n[0].nodeName.search(/div/i)===0?n.html(t):n.val(t)};t.Encrypt=function(n){var t=$("#"+n);return s(!1).done(function(n){if(n)try{var i=n.encrypt(f(t));i!==!1?e(t,i):SP.UI.Notify.addNotification("Encryption failed",!1);console.log(i)}catch(r){console.log(r)}}).fail(function(){SP.UI.Notify.addNotification("Failed to create crypto object",!1)}),!1};t.Decrypt=function(n){var t=$("#"+n);return s(!0).done(function(n){if(n)try{var i=n.decrypt(f(t));i!==!1?e(t,i):SP.UI.Notify.addNotification("Decryption failed",!1);console.log(i)}catch(r){console.log(r)}}).fail(function(){SP.UI.Notify.addNotification("Failed to create crypto object",!1)}),!1};t.Options={New:function(){i.location=L_Menu_BaseUrl+"/Pages/SetupRSA.aspx"},Cloud:function(){SP.UI.Notify.addNotification("Available in next version",!1);alert("Available in next version")}}}var i=window,t;n.RSA||(n.RSA=new r,typeof SPClientTemplates!="undefined")&&(t={},t.Templates={},t.Templates.Fields={RSA_Field1:{View:function(n){return xSolon.RSA.View(n)},DisplayForm:function(n){return xSolon.RSA.Display(n)},EditForm:function(n){return xSolon.RSA.Edit(n)},NewForm:function(n){return xSolon.RSA.New(n)}},RSA_Field2:{View:function(n){return xSolon.RSA.View(n)},DisplayForm:function(n){return xSolon.RSA.Display(n)},EditForm:function(n){return xSolon.RSA.Edit(n,"input")},NewForm:function(n){return xSolon.RSA.New(n,"input")}}},SPClientTemplates.TemplateManager.RegisterTemplateOverrides(t),ExecuteOrDelayUntilScriptLoaded(function(){},"SP.js"))}(window.xSolon=window.xSolon||{});
/*
//# sourceMappingURL=encryptedField.min.js.map
*/